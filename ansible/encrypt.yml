---
- hosts: servers
  vars_files:
    - vars.yml
  gather_facts: false
  become: True

  tasks:
    - name: Add repository for certbot
      apt_repository: 
        repo: ppa:certbot/certbot
        state: present
        update_cache: yes
    - name: Install certbot
      apt: 
        name: "{{ certbot }}"

    - name: Restart nginx
      service:
        name: nginx
        state: stopped
                    
    - name: Enable UFW (Firewall)
      ufw:
        state: enabled

    - name: Allow OpenSSH
      ufw:
        rule: allow
        name: OpenSSH

    - name: Allow Nginx Full
      ufw:
        rule: allow
        name: Nginx Full
  
    - name: Obtain SSL certificate
      shell: "certbot --nginx --noninteractive --agree-tos --email {{ certbot_admin_email }} -d {{ domain_1 }} -d {{ domain_2 }}"
      
      become: yes
